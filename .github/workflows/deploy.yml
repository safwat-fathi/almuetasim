name: CI and Deploy (SSH)
on:
  push:
    branches:
      - main
jobs:
  build-test-deploy:
    runs-on: ubuntu-latest
    env:
      PHP_VERSION: '8.4'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: pdo_mysql, mbstring, intl, bcmath, openssl, sodium
          coverage: none
      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist --no-progress
      - name: Build frontend assets
        if: ${{ hashFiles('package.json') != '' }}
        run: |
          if [ -f package-lock.json ] || [ -f npm-shrinkwrap.json ]; then
            npm ci
          else
            npm install
          fi
          if npm run | grep -q " build"; then
            npm run build
          fi
      - name: Optimize Composer for production
        run: composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist
      - name: Clean deploy ignores
        run: |
          rm -rf node_modules tests .git .github
          # Do not package a local SQLite DB; keep server DB intact
          rm -f database/database.sqlite || true
          # Never upload local .env to the server
          rm -f .env || true

      - name: Pre-deploy backup SQLite DB (safety)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.HOSTINGER_HOST }}
          username: ${{ secrets.HOSTINGER_USER }}
          port: ${{ secrets.HOSTINGER_PORT }}
          password: ${{ secrets.HOSTINGER_PASSWORD }}
          script: |
            set -e
            if [ -f "${{ secrets.HOSTINGER_PATH }}/database/database.sqlite" ]; then
              ts=$(date +%Y%m%d%H%M%S)
              cp "${{ secrets.HOSTINGER_PATH }}/database/database.sqlite" "${{ secrets.HOSTINGER_PATH }}/database/database.sqlite.$ts.bak"
              echo "Backed up SQLite to database/database.sqlite.$ts.bak"
            else
              echo "No existing SQLite DB to backup."
            fi
      - name: Upload via SCP (SSH key auth)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HOSTINGER_HOST }}
          username: ${{ secrets.HOSTINGER_USER }}
          port: ${{ secrets.HOSTINGER_PORT }}
          source: "."
          target: ${{ secrets.HOSTINGER_PATH }}
          overwrite: true
          rm: false
          strip_components: 0
          # key: ${{ secrets.HOSTINGER_SSH_KEY }}
          # passphrase: ${{ secrets.HOSTINGER_SSH_KEY_PASSPHRASE }}
          # If you only have password auth, add:
          password: ${{ secrets.HOSTINGER_PASSWORD }}
      - name: Post-deploy SSH tasks
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.HOSTINGER_HOST }}
          username: ${{ secrets.HOSTINGER_USER }}
          port: ${{ secrets.HOSTINGER_PORT }}
          # key: ${{ secrets.HOSTINGER_SSH_KEY }}
          # passphrase: ${{ secrets.HOSTINGER_SSH_KEY_PASSPHRASE }}
          # Or use password instead of key/passphrase above
          password: ${{ secrets.HOSTINGER_PASSWORD }}
          script: |
            set -e
            cd ${{ secrets.HOSTINGER_PATH }}
            echo "PHP version:" && php -v || true

            # Ensure .env exists and has APP_KEY
            if [ ! -f .env ]; then
              echo ".env not found. Creating from .env.example…"
              cp .env.example .env
            fi

            # Ensure Arabic locale by default
            if grep -q '^APP_LOCALE=' .env; then
              sed -i.bak 's/^APP_LOCALE=.*/APP_LOCALE=ar/' .env || true
            else
              echo 'APP_LOCALE=ar' >> .env
            fi
            if grep -q '^APP_FALLBACK_LOCALE=' .env; then
              sed -i.bak 's/^APP_FALLBACK_LOCALE=.*/APP_FALLBACK_LOCALE=ar/' .env || true
            else
              echo 'APP_FALLBACK_LOCALE=ar' >> .env
            fi

            # Generate APP_KEY if missing or empty
            if ! grep -q '^APP_KEY=' .env || [ -z "$(grep -E '^APP_KEY=' .env | cut -d= -f2)" ]; then
              echo "Generating APP_KEY…"
              php artisan key:generate --force || true
            fi

            # Permissions required by Laravel
            chmod -R ug+rwX storage bootstrap/cache 2>/dev/null || true

            # Ensure public/storage symlink exists (exposes storage/app/public)
            if [ ! -L public/storage ]; then
              php artisan storage:link || true
            fi

            # If document root is the project root (shared hosting),
            # ensure a correct root-level index.php exists that points to ./vendor and ./bootstrap
            if [ -f index.php ] && [ -d public ]; then
              if grep -q "__DIR__.'/../vendor/autoload.php'" index.php 2>/dev/null; then
                echo "Fixing root index.php paths for shared hosting…"
                # Build index.php by transforming public/index.php paths ../ -> ./
                php -r "file_put_contents('index.php', str_replace(\"__DIR__.'/../\", \"__DIR__.'/\", file_get_contents('public/index.php')));"
                chmod 644 index.php || true
              fi
            fi

            # For shared-hosting style root document root, expose public assets at root via symlinks
            if [ -f index.php ] && [ -d public ]; then
              # Replace any stale real directories with symlinks (DO NOT touch core storage dir)
              for p in build images uploads; do
                if [ -d "$p" ] && [ ! -L "$p" ]; then
                  rm -rf "$p"
                fi
              done

              ln -sfn public/build build || true
              ln -sfn public/images images || true

              # Map legacy /uploads/* URLs to /storage/uploads/*
              if [ -d public/storage/uploads ] || [ -L public/storage ]; then
                ln -sfn storage/uploads uploads || true
              fi
            fi

            # SAFETY: If storage/ at project root was mistakenly converted to a symlink, repair it
            if [ -L storage ]; then
              echo "Repairing root storage directory (was a symlink)…"
              rm -f storage
              mkdir -p storage/app/public \
                       storage/framework/cache \
                       storage/framework/sessions \
                       storage/framework/views \
                       storage/logs
              chmod -R ug+rwX storage || true
              php artisan storage:link || true
            fi

            # Ensure SQLite DB exists (first deploy) and has proper permissions; do not overwrite existing
            if [ ! -f database/database.sqlite ]; then
              echo "No SQLite DB found, creating empty database file…"
              mkdir -p database
              touch database/database.sqlite
            fi
            chmod 664 database/database.sqlite 2>/dev/null || true

            # Remove any Vite dev-server markers
            rm -f public/hot hot 2>/dev/null || true

            # Run database migrations
            php artisan migrate --force || true

            # Thoroughly clear all caches to avoid stale manifest/view assets
            php artisan cache:clear || true
            php artisan config:clear || true
            php artisan route:clear || true
            php artisan view:clear || true

            # Remove cached files as a fallback
            rm -f bootstrap/cache/config.php || true
            rm -f bootstrap/cache/routes-*.php || true
            rm -f bootstrap/cache/services.php || true
            rm -f bootstrap/cache/packages.php || true
            rm -rf storage/framework/views/* 2>/dev/null || true

            # Rebuild caches
            php artisan optimize || true
            php artisan config:cache || true
            php artisan route:cache || true
            php artisan view:cache || true
